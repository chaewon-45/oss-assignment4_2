<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>MockAPI CRUD with Bootstrap Modal</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-3">

  <h2>학생 데이터 관리</h2>

  <button id="btnStu" class="btn btn-primary mb-3">학생데이터 가져오기</button>
  <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addModal">
    학생데이터 추가
  </button>

  <div id="contents"></div>

  <!-- 1) ADD MODAL (학생 추가) -->
  <div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        
        <div class="modal-header">
          <h5 class="modal-title">학생 추가하기</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input id="add_name" class="form-control mb-2" placeholder="name">
          <input id="add_age" class="form-control mb-2" placeholder="age">
          <input id="add_major" class="form-control mb-2" placeholder="major">
          <input id="add_grade" class="form-control mb-2" placeholder="grade">
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
          <button class="btn btn-success" id="addSubmit">추가</button>
        </div>

      </div>
    </div>
  </div>


  <!-- 2) UPDATE MODAL (학생 수정) -->
  <div class="modal fade" id="updateModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        
        <div class="modal-header">
          <h5 class="modal-title">학생 정보 수정</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input id="upd_name" class="form-control mb-2">
          <input id="upd_age" class="form-control mb-2">
          <input id="upd_major" class="form-control mb-2">
          <input id="upd_grade" class="form-control mb-2">

          <!-- 여기에 어떤 id를 수정해야하는지 저장 -->
          <input type="hidden" id="upd_id">
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
          <button class="btn btn-primary" id="updateSubmit">수정</button>
        </div>

      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const BASE_URL = "https://6915287e84e8bd126af8d7a1.mockapi.io/students";

    window.onload = function() {
      document.getElementById("btnStu").addEventListener("click", getStudents);
      document.getElementById("addSubmit").addEventListener("click", postData);
      document.getElementById("updateSubmit").addEventListener("click", submitUpdate);
    }


    // GET (학생 불러오기)         
    function getStudents() {
      let contents = document.getElementById("contents");

      const xhr = new XMLHttpRequest();
      xhr.open("GET", BASE_URL);
      xhr.send();

      xhr.onload = () => {
        if (xhr.status === 200) {
          const res = JSON.parse(xhr.response);
          contents.innerHTML = makeList(res);
        }
      }
    }


    function makeList(data) {
      let str = "<ul>";
      data.forEach(stu => {
        str += `
          <li>
            <b>${stu.name}</b> (${stu.age})
            - Major: ${stu.major}, Grade: ${stu.grade}
            <button class="btn btn-sm btn-warning ms-2"
              onclick="openUpdateModal('${stu.id}', '${stu.name}', '${stu.age}', '${stu.major}', '${stu.grade}')">
              수정
            </button>
            <button class="btn btn-sm btn-danger ms-1"
              onclick="deleteData('${stu.id}')">
              삭제
            </button>
          </li>
        `;
      });
      str += "</ul>";
      return str;
    }


    // POST (학생 추가)   

    function postData() {
      const name = document.getElementById("add_name").value;
      const age = document.getElementById("add_age").value;
      const major = document.getElementById("add_major").value;
      const grade = document.getElementById("add_grade").value;

      const xhr = new XMLHttpRequest();
      xhr.open("POST", BASE_URL);
      xhr.setRequestHeader("content-type", "application/json");

      xhr.send(JSON.stringify({ name, age, major, grade }));

      xhr.onload = () => {
        if (xhr.status === 201) {
          getStudents();
          document.getElementById("addModal").querySelector(".btn-close").click();
        }
      }
    }

    // UPDATE 준비 (모달 열기)      
    function openUpdateModal(id, name, age, major, grade) {
      document.getElementById("upd_id").value = id;
      document.getElementById("upd_name").value = name;
      document.getElementById("upd_age").value = age;
      document.getElementById("upd_major").value = major;
      document.getElementById("upd_grade").value = grade;

      const modal = new bootstrap.Modal(document.getElementById("updateModal"));
      modal.show();
    }



    //UPDATE 제출          
    function submitUpdate() {
      const id = document.getElementById("upd_id").value;
      const name = document.getElementById("upd_name").value;
      const age = document.getElementById("upd_age").value;
      const major = document.getElementById("upd_major").value;
      const grade = document.getElementById("upd_grade").value;

      const xhr = new XMLHttpRequest();
      xhr.open("PUT", `${BASE_URL}/${id}`);
      xhr.setRequestHeader("content-type", "application/json");

      xhr.send(JSON.stringify({ name, age, major, grade }));

      xhr.onload = () => {
        if (xhr.status === 200) {
          getStudents();
          document.getElementById("updateModal").querySelector(".btn-close").click();
        }
      }
    }



    //DELETE (학생 삭제)
    function deleteData(id) {
      const xhr = new XMLHttpRequest();
      xhr.open("DELETE", `${BASE_URL}/${id}`);
      xhr.send();

      xhr.onload = () => {
        if (xhr.status === 200) getStudents();
      }
    }
  </script>

</body>
</html>
